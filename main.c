
#include <lib/ADC/voltageMeasurement.h>
#include "lib/CONVERT/convert.h"
#include "stm32f0xx.h"
#define LOG
#define TEMPERATURE_SENSOR

#ifdef LOG
#include "lib/USART/usart.h"
#endif


#include "lib/GSM/m95.h"
#ifdef TEMPERATURE_SENSOR
#include "lib/TEMPERATURE_SENSOR/temperatureSensor.h"
#endif
#include <assert.h>

char tempTick_about1ms = 0;


/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
int main(int argc, char* argv[]) {

#ifdef LOG
	initUsart();
#endif
	initVoltageMeasurement_g();
	initM95();
#ifdef TEMPERATURE_SENSOR
	init_temperatureSensor();
#endif
	while (1) {
		static int tempInternalCounterDelay = 0;
		tempMainTask();

		if (150 < tempInternalCounterDelay) {
			tempInternalCounterDelay = 0;
			tempTick_about1ms = 1;
		}
		tempInternalCounterDelay++;
	}
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
char isTick() {
	if (tempTick_about1ms) {
		tempTick_about1ms = 0;
		return 1;
	}
	return 0;
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void tempMainTask() {
#define TWO_SECONDS_MM_U16		     ((uint16_t)(2000))
#define FIVE_SECONDS_MM_U16	         ((uint16_t)(5000))
#define TWO_MINUTES_MM_U32	       ((uint32_t)(180000))
#define ONE_HOUR_MM_U32       	  ((uint32_t)(3600000))
#define TWO_HOURS_MM_U32   		((uint32_t)(2*3600000))
#define FIVE_HOURS_MM_U32		((uint32_t)(5*3600000))

	static uint16_t counter5sShift2s_U16 = TWO_SECONDS_MM_U16;
	static uint16_t counter5sShift0s_U16 = 0;
	static uint32_t counter2min_U32 = TWO_MINUTES_MM_U32
			- (TWO_SECONDS_MM_U16 + 4 * FIVE_SECONDS_MM_U16);
	static uint32_t counter1h_U32;
	static uint32_t counter5hShift2h_U32 = TWO_HOURS_MM_U32;
	static uint32_t counter30Shift_U32 = ONE_HOUR_MM_U32 / 60 * 29;
	static uint32_t counter10s_U16 = 0;
	static uint32_t counter1s_U16 = TWO_SECONDS_MM_U16 / 4;

	if (TWO_SECONDS_MM_U16 / 2 <= counter1s_U16) {
		tasks1s();
		counter1s_U16 = 0;
	}

	if (ONE_HOUR_MM_U32 / 2 <= counter30Shift_U32) {
		tasks30min();
		counter30Shift_U32 = 0;
	}

	if (FIVE_SECONDS_MM_U16 <= counter5sShift2s_U16) {
		tasks5sShift2s();
		counter5sShift2s_U16 = 0;
	}
	if (FIVE_SECONDS_MM_U16 <= counter5sShift0s_U16) {
		tasks5sShift0s();
		counter5sShift0s_U16 = 0;
	}
	if (FIVE_SECONDS_MM_U16 * 2 <= counter10s_U16) {
		tasks10s();
		counter10s_U16 = 0;
	}
	if (TWO_MINUTES_MM_U32 <= counter2min_U32) {
		tasks2min();
		counter2min_U32 = 0;
	}
	if (ONE_HOUR_MM_U32 <= counter1h_U32) {
		tasks1h();
		counter1h_U32 = 0;
	}
	if (FIVE_HOURS_MM_U32 <= counter5hShift2h_U32) {
		tasks5hShift2h();
		counter5hShift2h_U32 = 0;
	}

	if (isTick()) {
		counter5sShift2s_U16++;
		counter5sShift0s_U16++;
		counter2min_U32++;
		counter1h_U32++;
		counter5hShift2h_U32++;
		counter30Shift_U32++;
		counter10s_U16++;
		counter1s_U16++;
	}
	task0();
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void task0() {
	task1_GSM();
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void tasks5sShift2s() {

	taskVoltageMeasurement_g();
#ifdef TEMPERATURE_SENSOR
	task_temperatureSensor();
#endif
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
tasks1s() {
	task2_GSM();
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void tasks5sShift0s() {

}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
tasks10s() {
#ifdef LOG
	char st[20];
	floatToString__toCheckAndRewrite(
			meausreVoltage(), st);
	sendUsart("voltage ");
	sendUsart(st);
	sendUsart("V \n\r");

	floatToString__toCheckAndRewrite(getActualTemperature(), st);
	sendUsart("temperature ");
	sendUsart(st);
	sendUsart("C \n\r");
#endif
}
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void tasks2min() {

	char st[20];
	floatToString__toCheckAndRewrite(getActualVoltageMeasurment_g(), st);
	sendSensor6_gprs(st);
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void tasks30min() {

}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void tasks1h() {

}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
void tasks5hShift2h() {
}

/////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////
///////////////   USART2_IRQHandler    //////////////////////////////
///////////////   USART2_IRQHandler    //////////////////////////////
///////////////   USART2_IRQHandler    //////////////////////////////
/////////////////////////////////////////////////////////////////////
void USART2_IRQHandler(void)

{

	if (USART_GetITStatus(USART2, USART_IT_RXNE) == SET) { 

		USART_ClearITPendingBit(USART2, USART_IT_RXNE);
		;

		USART_SendData(USART1, USART_ReceiveData(USART2));
		m95On();
	}

}

